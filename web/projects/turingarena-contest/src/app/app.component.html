<ng-container *ngIf="contestQuery.valueChanges | async as contestResult">
  <ng-container *ngIf="contestResult.data as data">
    <ng-container *ngIf="stateObservable | async as state">
      <nav class="topbar">
        <h1 class="contest-title"><a href="#" (click)="selectedProblemName = undefined; $event.preventDefault()">
            {{data.contestView.contestTitle}}
          </a></h1>
        <ng-container *ngIf="data.contestView.user">
          <span class="user-display-name">{{data.contestView.user.displayName}}</span>
          <button class="user-logout" (click)="setAuth(undefined)">
            <fa-icon [icon]="faSignOutAlt"></fa-icon>
            Logout
          </button>
        </ng-container>
        <ng-container *ngIf="!data.contestView.user">
          <button class="user-login" (click)="openLoginDialog()">
            <fa-icon [icon]="faSignInAlt"></fa-icon>
            Login
          </button>
        </ng-container>
      </nav>
      <div class="contest-main">
        <ng-container *ngIf="!focusMode">
          <aside class="contest-aside">
            <ng-container *ngIf="state.hasScore">
              <h2>Score</h2>
              <div class="contest-score-panel">
                <span class="contest-score">
                  {{ state.score.toFixed(state.precision) }}
                </span>/<span class="contest-max-score">
                  {{ state.maxScore.toFixed(state.precision) }}
                </span>
              </div>
            </ng-container>
            <ng-container *ngIf="nowObservable | async as now">
              <ng-container *ngIf="state.startTime <= now && now <= state.endTime">
                <h2>Remaining Time</h2>
                <div class="contest-clock remaining-time">
                  {{ formatDuration(state.endTime.diff(now)) }}
                </div>
              </ng-container>
              <ng-container *ngIf="now < state.startTime">
                <h2>Starting In</h2>
                <div class="contest-clock starting-in-time">
                  {{ formatDuration(state.startTime.diff(now)) }}
                </div>
              </ng-container>
              <ng-container *ngIf="state.endTime < now">
                <h2>Ended</h2>
                <div class="contest-clock ended-by-time">
                  {{ formatDuration(now.diff(state.endTime)) }}
                </div>
              </ng-container>
            </ng-container>
            <ng-container *ngIf="data.contestView.problems as problems">
              <h2>Problems</h2>
              <div class="contest-problems">
                <ng-container *ngFor="let problem of problems">
                  <a class="contest-problem" href="#" [title]="problem.material.title | textVariant"
                    [class.active]="problem.name === selectedProblemName"
                    (click)="selectedProblemName = problem.name; $event.preventDefault()">
                    <ng-container *ngIf="state.getProblemState(problem) as problemState">
                      <span class="contest-problem-score" [class.zero]="problemState.score <= 0"
                        [class.partial]="0 < problemState.score && problemState.score < problemState.maxScore"
                        [class.full]="problemState.maxScore <= problemState.score">
                        {{ problemState.score.toFixed(problemState.precision) }} /
                        {{ problemState.maxScore.toFixed(problemState.precision) }}
                      </span>
                    </ng-container>
                    {{ problem.material.title | textVariant:'short' }}
                  </a>
                </ng-container>
              </div>
            </ng-container>
          </aside>
        </ng-container>
        <ng-container *ngFor="let problem of data.contestView.problems">
          <ng-container *ngIf="selectedProblemName === problem.name">
            <ng-container *ngIf="focusMode">
              <aside class="btn-group-vertical">
                <ng-container *ngIf="problem.canSubmit || problem.submissions">
                  <ng-container *ngIf="problem.canSubmit">
                    <a href="#" class="problem-submit" style="border-radius: 0" (click)="openSubmitDialog(); $event.preventDefault()">
                      <fa-icon [icon]="faPaperPlane"></fa-icon>
                    </a>
                  </ng-container>
                </ng-container>
                <ng-container *ngIf="problem.submissions as submissions">
                  <ng-container *ngIf="submissions[submissions.length-1] as lastSubmission">
                    <a href="#" class="problem-last-submission"
                      (click)="openSubmission(lastSubmission); $event.preventDefault()">
                      <fa-icon *ngIf="lastSubmission.status !== 'PENDING'" [icon]="faHistory"></fa-icon>
                      <fa-icon *ngIf="lastSubmission.status === 'PENDING'" [icon]="faSpinner" [pulse]="true">
                      </fa-icon>
                    </a>
                    <a href="#" class="problem-submission-list"
                      (click)="openSubmissionList(problem); $event.preventDefault()">
                      <fa-icon [icon]="faList"></fa-icon>
                    </a>
                  </ng-container>
                </ng-container>
                <ng-container *ngIf="data.contestView.problems as problems">
                  <ng-container *ngFor="let problem of problems; index as index">
                    <a class="btn" href="#" [title]="problem.material.title | textVariant"
                      [class.btn-primary]="problem.name === selectedProblemName"
                      [class.btn-outline-primary]="problem.name !== selectedProblemName"
                      (click)="selectedProblemName = problem.name; $event.preventDefault()">
                      {{getTaskLetter(index)}}
                    </a>
                  </ng-container>
                </ng-container>
              </aside>
            </ng-container>
            <ng-container *ngIf="!focusMode">
              <aside class="problem-aside">
                <!-- <h2 class="problem-title">{{ problem.material.title | textVariant }}</h2> -->
                <ng-container *ngIf="problem.canSubmit || problem.submissions">
                  <div class="problem-submission-panel">
                    <ng-container *ngIf="problem.canSubmit">
                      <a href="#" class="problem-submit" (click)="openSubmitDialog(); $event.preventDefault()">
                        <fa-icon [icon]="faPaperPlane"></fa-icon>
                        Submit a solution
                      </a>
                    </ng-container>
                    <ng-container *ngIf="problem.submissions as submissions">
                      <!-- <h2>Submissions</h2> -->
                      <ng-container *ngIf="submissions[submissions.length-1] as lastSubmission">
                        <a href="#" class="problem-last-submission"
                          (click)="openSubmission(lastSubmission); $event.preventDefault()">
                          <fa-icon *ngIf="lastSubmission.status !== 'PENDING'" [icon]="faHistory"></fa-icon>
                          <fa-icon *ngIf="lastSubmission.status === 'PENDING'" [icon]="faSpinner" [pulse]="true">
                          </fa-icon>
                          Last submission
                          <!-- <app-relative-time [time]="lastSubmission.createdAt"></app-relative-time> -->
                        </a>
                        <a href="#" class="problem-submission-list"
                          (click)="openSubmissionList(problem); $event.preventDefault()">
                          <fa-icon [icon]="faList"></fa-icon>
                          All submissions
                        </a>
                      </ng-container>
                    </ng-container>
                  </div>
                </ng-container>
                <ng-container *ngIf="problem.material.awards as awards">
                  <h2>Awards</h2>
                  <div class="problem-awards">
                    <ng-container *ngFor="let award of awards">
                      <div class="problem-award">
                        <ng-container *ngIf="state.getProblemState(problem).getAwardState(award) as state">
                          <ng-container *ngIf="award.content.range as range">
                            <span class="problem-award-badge" [class.zero]="state.score <= 0"
                              [class.partial]="0 < state.score && state.score < range.max"
                              [class.full]="range.max <= state.score">
                              {{ state.score.toFixed(range.precision) }} / {{ range.max.toFixed(range.precision) }}
                            </span>
                          </ng-container>
                          <ng-container *ngIf="!award.content.range">
                            <ng-container *ngIf="state.badge">
                              <span class="problem-award-badge full">
                                &#x2713;
                              </span>
                            </ng-container>
                            <ng-container *ngIf="!state.badge">
                              <span class="problem-award-badge zero">
                                &#x2717;
                              </span>
                            </ng-container>
                          </ng-container>
                        </ng-container>
                        {{award.title | textVariant}}
                      </div>
                    </ng-container>
                  </div>
                </ng-container>
                <ng-container *ngIf="problem.material.attachments as attachments">
                  <h2>Attachments</h2>
                  <div class="problem-attachments">
                    <a class="problem-attachment" [title]="attachment.title | textVariant"
                      *ngFor="let attachment of attachments" [download]="attachment.file[0].name"
                      [href]="'data:' + (attachment.file[0].type || 'application/octet-stream') + ';base64,' + attachment.file[0].content.base64 | bypassSanitizer:'Url'">
                      <fa-icon [icon]="mimeTypeIcons[attachment.file[0].type] || faFile"></fa-icon>
                      {{attachment.title | textVariant}}
                    </a>
                  </div>
                  <h2>Statement file</h2>
                  <ng-container *ngIf="problem.material.statement[0] as statement">
                    <a class="problem-download-statement" [title]="statement.name" [download]="statement.name"
                      [href]="'data:' + (statement.type || 'application/octet-stream') + ';base64,' + statement.content.base64 | bypassSanitizer:'Url'">
                      <fa-icon [icon]="mimeTypeIcons[statement.type] || faFile"></fa-icon>
                      {{statement.name}}
                    </a>
                  </ng-container>
                </ng-container>
              </aside>
            </ng-container>

            <aside class="focus-mode-toggler" (click)="focusMode = !focusMode">
              <fa-icon [icon]="focusMode ? faChevronRight : faChevronLeft"></fa-icon>
            </aside>

            <ng-container *ngIf="problem.material.statement[0] as statement">
              <iframe class="problem-statement"
                [attr.src]="'data:' + statement.type + ';base64,' + statement.content.base64 | bypassSanitizer:'ResourceUrl'">
              </iframe>
            </ng-container>
          </ng-container>
        </ng-container>
        <ng-container *ngIf="!selectedProblemName">
          HOME (todo)
        </ng-container>
      </div>
    </ng-container>
  </ng-container>
</ng-container>
<!-- <div class="score_badges_container">
  <span class="task_best_scores_label">Score badges: </span>
  <ng-container *ngFor="let award of problem.material.awards">
    <ng-container *ngIf="state.getProblemState(problem).getAwardState(award) as state">
      <ng-container *ngIf="award.content.range as range">
        <ng-template #tipContent>
          {{award.title | textVariant}}
          <span class="badge badge-info">+{{range.max.toFixed(range.precision)}} pts</span>
        </ng-template>
        <span [ngbTooltip]="tipContent" class="award_badge" [class.score_zero]="state.score <= 0"
          [class.score_partial]="0 < state.score && state.score < range.max"
          [class.score_full]="range.max <= state.score">
          {{ state.score.toFixed(range.precision) }}
        </span>
      </ng-container>
      <ng-container *ngIf="!award.content.range">
        <ng-template #tipContent>
          {{award.title | textVariant}}
        </ng-template>
        <ng-container *ngIf="state.badge">
          <span [ngbTooltip]="tipContent" class="award_badge score_full">
            &#x2713;
          </span>
        </ng-container>
        <ng-container *ngIf="!state.badge">
          <span [ngbTooltip]="tipContent" class="award_badge score_zero">
            &#x2717;
          </span>
        </ng-container>
      </ng-container>
    </ng-container>
  </ng-container>
  <ng-container *ngIf="problem.material.statement[0] as statement">
    <a [download]="statement.name"
      [href]="'data:' + statement.type + ';base64,' + statement.content.base64 | bypassSanitizer:'Url'"
      class="btn btn-outline-dark btn-sm float-right">
      <fa-icon [icon]="faFilePdf"></fa-icon>
      Download
    </a>
  </ng-container>
  <div>
    <span class="task_download_attachments_label">Attachments: </span>
    <a *ngFor="let attachment of problem.material.attachments; last as last" [download]="attachment.file[0].name"
      [href]="'data:' + (attachment.file[0].type || 'application/octet-stream') + ';base64,' + attachment.file[0].content.base64 | bypassSanitizer:'Url'">
      {{attachment.title | textVariant}}
      <ng-container *ngIf="!last"> | </ng-container>
    </a>
  </div>
</div> -->
